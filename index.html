<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ruka Lattialämmitys One-File</title>
  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React & ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <!-- Babel standalone for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Axios for HTTP requests -->
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <!-- Firebase compat libraries -->
  <script src="https://www.gstatic.com/firebasejs/10.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore-compat.js"></script>
  <!-- Day.js for timestamps -->
  <script src="https://unpkg.com/dayjs/dayjs.min.js"></script>
</head>
<body class="bg-gray-50">
  <div id="root" class="min-h-screen"></div>

  <!-- Application Script -->
  <script type="text/babel">
    const { useState, useEffect } = React;

    // Proxy setup: define proxy server URL (local dev)
    const PROXY_URL = 'http://localhost:5000'; // change if your proxy runs elsewhere
    const authUrl = `${PROXY_URL}/api/TokenAuth/Authenticate`;
    const baseApi = `${PROXY_URL}/api/services/app`;

    // Firebase config and initialization (compat)
    const firebaseConfig = {
      apiKey: "AIzaSyAiOUIm2n_2vitM4ZM0QYeKO1Io9ezj6Wk",
      authDomain: "ruka-393ba.firebaseapp.com",
      projectId: "ruka-393ba",
      storageBucket: "ruka-393ba.appspot.com",
      messagingSenderId: "260943821874",
      appId: "1:260943821874:web:9a4ce89c1591599ae5d02b",
      measurementId: "G-1F8728CX4T"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // EbecoConnect API helpers
    const creds = { userNameOrEmailAddress: "karl.uusitalo@outlook.com", password: "04408049Eo" };
    let token = null;

    async function authenticate() {
      try {
        const res = await axios.post(authUrl, creds);
        token = res.data.result.accessToken;
      } catch (err) {
        throw new Error("Autentikointi epäonnistui: " + (err.response?.status || err.message));
      }
    }

    async function getFloorStatus() {
      if (!token) await authenticate();
      try {
        const res = await axios.get(`${baseApi}/FloorHeating/GetStatus`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        return res.data.result;
      } catch (err) {
        throw new Error("Tietojen haku epäonnistui: " + (err.response?.status || err.message));
      }
    }

    async function setTargetTemperature(val) {
      if (!token) await authenticate();
      try {
        const res = await axios.post(
          `${baseApi}/FloorHeating/SetTemperature`,
          { temperature: val },
          { headers: { Authorization: `Bearer ${token}` } }
        );
        return res.data.success;
      } catch (err) {
        throw new Error("Asetuksen muutos epäonnistui: " + (err.response?.status || err.message));
      }
    }

    // React components
    function Login({ onLogin }) {
      return (
        <div className="h-screen flex flex-col items-center justify-center bg-gray-100">
          <h1 className="text-2xl font-semibold mb-4">Kirjaudu sisään</h1>
          <button
            className="px-6 py-2 bg-blue-600 text-white rounded-lg"
            onClick={onLogin}
          >
            Käytä lattialämmitystä
          </button>
        </div>
      );
    }

    function TemperatureControl({ current, onSet }) {
      const [val, setVal] = useState(current);
      return (
        <div className="flex items-center space-x-2">
          <input
            type="number"
            value={val}
            onChange={e => setVal(+e.target.value)}
            className="w-16 p-1 border rounded"
          />
          <button
            className="px-4 py-1 bg-green-600 text-white rounded"
            onClick={() => onSet(val)}
          >
            Aseta
          </button>
        </div>
      );
    }

    function Dashboard({ onError }) {
      const [status, setStatus] = useState(null);
      const [loading, setLoading] = useState(true);

      useEffect(() => { fetchStatus(); }, []);

      async function fetchStatus() {
        setLoading(true);
        try {
          const s = await getFloorStatus();
          setStatus(s);
        } catch (e) {
          onError(e.message);
        } finally {
          setLoading(false);
        }
      }

      async function onSet(val) {
        try {
          const ok = await setTargetTemperature(val);
          if (ok) {
            await db.collection('temperatureLogs').add({ timestamp: dayjs().toISOString(), target: val });
            fetchStatus();
          }
        } catch (e) {
          onError(e.message);
        }
      }

      if (loading) return <div className="p-4">Ladataan tietoja...</div>;

      return (
        <div className="p-4 space-y-6">
          <h2 className="text-xl font-bold">Mökin lattialämmityksen tila</h2>
          <div>Nykyinen lämpötila: {status.currentTemperature}°C</div>
          <div>Asetus: {status.targetTemperature}°C</div>
          <TemperatureControl current={status.targetTemperature} onSet={onSet} />
        </div>
      );
    }

    function App() {
      const [auth, setAuth] = useState(false);
      const [error, setError] = useState(null);

      useEffect(() => {
        authenticate()
          .then(() => setAuth(true))
          .catch(e => setError(e.message));
      }, []);

      if (error) return <div className="p-4 text-red-600">Virhe: {error}</div>;
      if (!auth) return <Login onLogin={() => setAuth(true)} />;

      return <Dashboard onError={msg => setError(msg)} />;
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
